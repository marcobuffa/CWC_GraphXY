<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>GraphXY CWC</title>
        <link rel="stylesheet" href="css/style.css">
        <script src="libs/webcc.min.js"></script>
        <script src="libs/chart.js"></script>
    </head>
    <body>
        <div>
            <p id="Connection">Questo CWC è in esecuzione in un <em>browser</em></p>
        </div>
        <div>
            <canvas id="myChart"></canvas>
        </div>

        <script>

            var Xarray = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15];
            var Yarray = [1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2];
            var Color = 0xFF009090;
            var Label = "Serie";
            var Thickness = 1;
            var PointSize = 5;

            const mychart = new Chart(document.getElementById('myChart'), {
                type: 'line',
                data: {
                    datasets: [{
                        label: "",
                        data: [],
                        borderWidth: 1,
                        borderColor: toColor(Color),
                        radius: 5
                    }]
                },
                options: {
                    scales: {
                        y: {
                            type: 'linear'
                        },
                        x: {
                            type: 'linear'
                        }
                    },
                    plugins: {
                        legend: {
                            display: !(Label.length === 0)
                        }
                    }
                }
            });

            function toColor(num) {
                num >>>= 0;
                var b = num & 0xFF,
                g = (num & 0xFF00) >>> 8,
                r = (num & 0xFF0000) >>> 16,
                a = ((num & 0xFF000000) >>> 24) / 255;

                return 'rgba(' + [r, g, b, a].join(',') + ')';
            }

            function updateChart() {
                 //calcolo della lunghezza dell'array (x, y) prendendo il più corto dei 2 array passati da WinCC
                let lim = Xarray.length < Yarray.length ? Xarray.length : Yarray.length;
                //svuotamento array (x, y) in modo da eliminare eventuali residui
                mychart.data.datasets[0].data.length = 0;
                //generazione array (x, y) direttamente nel grafico chartJS
                for (let i = 0; i < lim; i++) {
                    mychart.data.datasets[0].data[i] = {"x": Xarray[i], "y": Yarray[i]};
                }
                //impostazione del colore
                mychart.data.datasets[0].borderColor = toColor(Color);
                //impostazione dell'etichetta della serie
                mychart.data.datasets[0].label = Label;
                //impostazione dello spessore della linea
                mychart.data.datasets[0].borderWidth = Thickness;
                //impostazione della dimensione dei pallini
                mychart.data.datasets[0].radius = PointSize;
                //aggiornamento del grafico
                mychart.update();
            }

            //Callback nuovi parametri da WinCC
            function dataFromWinCC(data){
                //data.value --> nuovo valore
                //data.key --> nome del parametro aggiornato
                console.log("Nuovo parametro ricevuto da WinCC:");
                console.log(data);
				switch (data.key) {
                    case "Xarray":
                        Xarray = JSON.parse(WebCC.Properties.Xarray);
                        break;
                    case "Yarray":
                        Yarray = JSON.parse(WebCC.Properties.Yarray);
                        break;
                    case "Color":
                        Color = WebCC.Properties.Color;
                        break;
                    case "Label":
                        Label = WebCC.Properties.Label;
                        break;
                    case "Thickness":
                        Thickness = WebCC.Properties.Thickness;
                        break;
                    case "PointSize":
                        PointSize = WebCC.Properties.PointSize;
                        break;
                }
                updateChart();
			}
            
            //connessione con WinCC
            WebCC.start(
                function(result) {
                    if (result) { //c'è un'istanza di WinCC in esecuzione
                        console.log("Connessione con WinCC avvenuta con successo");
                        if (WebCC.isDesignMode) { //l'istanza è di ingegneria (TIA Portal)
							document.getElementById('Connection').innerHTML = "Questo CWC è in esecuzione in <em>ingegneria (TIA Portal)</em>";
						} else { //l'istanza è di runtime
                            document.getElementById('Connection').innerHTML = "Questo CWC è in esecuzione nel <em>runtime</em>";
						}
                        try {
                            WebCC.onPropertyChanged.subscribe(dataFromWinCC); //registrazione callback chiamata quando arrivano nuovi dati da WinCC
                        } 
                        catch (error) {
                            console.log(error);
                        }
                    } else {
                        console.log("Connessione con WinCC non riuscita (sono in un browser?)");
                    }
                    updateChart();
                },
                {
                    //dichiarazione di metodi, eventi e parametri (deve coincidere con il manifest!)
                    methods: {
                        ForceRedraw: function(){
                            mychart.update();
                        },
                    },
                    events: [],
                    properties: {
                        Xarray: "[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15]",
                        Yarray: "[1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2]",
                        Color: 0xFF009090,
                        Label: "Serie",
                        Thickness: 1,
                        PointSize: 5
                    }
                },
                ["HMI"],
                10000
            );
        </script>
    </body>
</html>